<!DOCTYPE html>  <html> <head>   <title>seer_application.coffee</title>   <meta http-equiv="content-type" content="text/html; charset=UTF-8">   <link rel="stylesheet" media="all" href="docco.css" /> </head> <body>   <div id="container">     <div id="background"></div>            <div id="jump_to">         Jump To &hellip;         <div id="jump_wrapper">           <div id="jump_page">                                           <a class="source" href="initialize.html">                 initialize.coffee               </a>                                           <a class="source" href="seer_application.html">                 seer_application.coffee               </a>                        </div>         </div>       </div>          <table cellpadding="0" cellspacing="0">       <thead>         <tr>           <th class="docs">             <h1>               seer_application.coffee             </h1>           </th>           <th class="code">           </th>         </tr>       </thead>       <tbody>                               <tr id="section-1">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-1">&#182;</a>               </div>               <p>SeerApplication is the basic foundation
for a deployment instance of SimpleSeer.
Each deployment will extend this definition
to provide additional functionality.</p>             </td>             <td class="code">               <div class="highlight"><pre><span class="nx">require</span> <span class="s">&#39;lib/view_helper&#39;</span>
<span class="nx">require</span> <span class="s">&#39;lib/transitions&#39;</span>

<span class="nv">module.exports = SeerApplication =</span>
  <span class="nv">settings: </span><span class="p">{}</span>
  <span class="nv">menuItems: </span><span class="p">{}</span>
  <span class="nv">menuBars: </span><span class="p">{}</span>
  <span class="nv">context: </span><span class="p">{}</span>
  <span class="nv">alertStack: </span><span class="p">[]</span> 
  <span class="nv">inAnim: </span><span class="kc">false</span>
  </pre></div>             </td>           </tr>                               <tr id="section-2">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-2">&#182;</a>               </div>               <p>Set up the application and include the 
necessary modules. Configures the page
and </p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nv">_init: </span><span class="nf">(settings) -&gt;</span>
    <span class="vi">@settings = </span><span class="nx">_</span><span class="p">.</span><span class="nx">extend</span> <span class="nx">@settings</span><span class="p">,</span> <span class="nx">settings</span>
    
    <span class="k">if</span> <span class="nx">@settings</span><span class="p">.</span><span class="nx">mongo</span><span class="p">.</span><span class="nx">is_slave</span>
      <span class="nx">$</span><span class="p">(</span><span class="s">&quot;.notebook&quot;</span><span class="p">).</span><span class="nx">hide</span><span class="p">()</span>
      
    <span class="k">if</span> <span class="o">!</span><span class="nx">@settings</span><span class="p">.</span><span class="nx">template_paths</span><span class="o">?</span>
      <span class="vi">@settings.template_paths = </span><span class="p">{}</span>
      
    <span class="vi">@subscriptions = </span><span class="p">{}</span>
    <span class="vi">@timeOffset = </span><span class="p">(</span><span class="k">new</span> <span class="nb">Date</span><span class="p">()).</span><span class="nx">getTimezoneOffset</span><span class="p">()</span> <span class="o">*</span> <span class="mi">60</span> <span class="o">*</span> <span class="mi">1000</span></pre></div>             </td>           </tr>                               <tr id="section-3">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-3">&#182;</a>               </div>               <p>Set up the client name.</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="nx">$</span><span class="p">(</span><span class="s">&#39;#client-name&#39;</span><span class="p">).</span><span class="nx">html</span><span class="p">(</span><span class="nb">window</span><span class="p">.</span><span class="nx">SimpleSeer</span><span class="p">.</span><span class="nx">settings</span><span class="p">.</span><span class="nx">ui_pagename</span> <span class="o">||</span> <span class="s">&quot;&quot;</span><span class="p">)</span>

    <span class="k">if</span> <span class="nb">window</span><span class="p">.</span><span class="nx">WebSocket</span><span class="o">?</span>
      <span class="vi">@socket = </span><span class="nx">io</span><span class="p">.</span><span class="nx">connect</span> <span class="s">&#39;/rt&#39;</span></pre></div>             </td>           </tr>                               <tr id="section-4">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-4">&#182;</a>               </div>               <p>@.socket.on 'timeout', ->
@.socket.on 'connect', ->
@.socket.on 'error', ->
@.socket.on 'disconnect', ->
@.socket.on 'message', (msg) -></p>             </td>             <td class="code">               <div class="highlight"><pre>      <span class="nx">@socket</span><span class="p">.</span><span class="nx">on</span> <span class="s">&quot;message:alert/&quot;</span><span class="p">,</span> <span class="nb">window</span><span class="p">.</span><span class="nx">SimpleSeer</span><span class="p">.</span><span class="nx">_serveralert</span>
      <span class="nx">@socket</span><span class="p">.</span><span class="nx">emit</span> <span class="s">&#39;subscribe&#39;</span><span class="p">,</span> <span class="s">&#39;alert/&#39;</span>
      
    <span class="nv">m = </span><span class="nx">require</span> <span class="s">&#39;collections/measurements&#39;</span>
    <span class="vi">@measurements = </span><span class="k">new</span> <span class="nx">m</span><span class="p">()</span>
    <span class="nx">@measurements</span><span class="p">.</span><span class="nx">fetch</span><span class="p">()</span>
    <span class="nv">t = </span><span class="nx">require</span> <span class="s">&#39;views/core/modal&#39;</span>
    <span class="vi">@modal = </span><span class="k">new</span> <span class="nx">t</span><span class="p">()</span>

    
    <span class="nx">$</span><span class="p">(</span><span class="s">&quot;</span><span class="err">#</span><span class="s">slides&quot;</span><span class="p">).</span><span class="nx">infiniteScroll</span>
      <span class="nx">onScroll</span><span class="o">:</span><span class="nf">(per) =&gt;</span>
        <span class="nx">@activeTab</span><span class="p">.</span><span class="nx">trigger</span> <span class="s">&#39;scroll&#39;</span><span class="p">,</span> <span class="nx">per</span>
      <span class="nv">onPage: </span><span class="o">=&gt;</span>
        <span class="nx">@activeTab</span><span class="p">.</span><span class="nx">trigger</span> <span class="s">&#39;page&#39;</span></pre></div>             </td>           </tr>                               <tr id="section-5">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-5">&#182;</a>               </div>               <p>Set up the timeout message dialog.</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="nx">$</span><span class="p">(</span><span class="s">&#39;#lost_connection&#39;</span><span class="p">).</span><span class="nx">dialog</span>
      <span class="nv">autoOpen: </span><span class="kc">false</span>
      <span class="nv">modal: </span><span class="kc">true</span>
      <span class="nv">buttons:</span>
        <span class="nv">Ok: </span><span class="nf">-&gt;</span>
          <span class="nx">$</span><span class="p">(</span> <span class="k">this</span> <span class="p">).</span><span class="nx">dialog</span><span class="p">(</span> <span class="s">&quot;close&quot;</span> <span class="p">)</span>

  <span class="nv">_preinitialize: </span><span class="nf">-&gt;</span>
    <span class="nv">tc = </span><span class="nx">require</span> <span class="s">&#39;collections/tab_container&#39;</span>
    <span class="vi">@tabs = </span><span class="k">new</span> <span class="nx">tc</span><span class="p">()</span>
    <span class="nx">@tabs</span><span class="p">.</span><span class="nx">fetch</span><span class="p">()</span>
  
  <span class="nv">route: </span><span class="nf">(route, name=false, callback= =&gt;) -&gt;</span>
    <span class="nx">console</span><span class="p">.</span><span class="nx">log</span> <span class="nx">route</span><span class="p">,</span><span class="nx">name</span><span class="p">,</span><span class="nx">callback</span>
    <span class="k">for</span> <span class="nx">r</span> <span class="k">in</span> <span class="nx">Backbone</span><span class="p">.</span><span class="nx">history</span><span class="p">.</span><span class="nx">handlers</span>
      <span class="nx">console</span><span class="p">.</span><span class="nx">log</span> <span class="nx">r</span>
    <span class="nx">@router</span><span class="p">.</span><span class="nx">route</span> <span class="nx">route</span><span class="p">,</span> <span class="nx">name</span><span class="p">,</span> <span class="nx">callback</span></pre></div>             </td>           </tr>                               <tr id="section-6">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-6">&#182;</a>               </div>               <p>Sends an alert window to the client
with the specified message and severity.</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nv">_serveralert: </span><span class="nf">(msg) -&gt;</span>
    <span class="nb">window</span><span class="p">.</span><span class="nx">SimpleSeer</span><span class="p">.</span><span class="nx">alert</span><span class="p">(</span><span class="nx">msg</span><span class="p">[</span><span class="s">&#39;data&#39;</span><span class="p">][</span><span class="s">&#39;message&#39;</span><span class="p">],</span> <span class="nx">msg</span><span class="p">[</span><span class="s">&#39;data&#39;</span><span class="p">][</span><span class="s">&#39;severity&#39;</span><span class="p">])</span></pre></div>             </td>           </tr>                               <tr id="section-7">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-7">&#182;</a>               </div>               <p>Returns the loading status of the application.</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nv">isLoading: </span><span class="o">=&gt;</span>
    <span class="o">!</span><span class="nx">$</span><span class="p">(</span><span class="s">&#39;#modal :hidden&#39;</span><span class="p">).</span><span class="nx">length</span>

  <span class="nx">addMenuBar</span><span class="o">:</span><span class="nf">(target, options) -&gt;</span>
    <span class="nv">_lib = </span><span class="nx">require</span> <span class="s">&#39;views/core/menubar&#39;</span>
    <span class="nv">_t = </span><span class="nx">$</span><span class="p">(</span><span class="s">&quot;</span><span class="err">#</span><span class="s">&quot;</span><span class="o">+</span><span class="nx">target</span><span class="p">)</span>
    <span class="k">if</span> <span class="nx">_t</span><span class="p">.</span><span class="nx">length</span> <span class="o">&gt;</span> <span class="mi">0</span>
      <span class="k">if</span> <span class="o">!</span><span class="nx">options</span><span class="p">.</span><span class="nx">id</span><span class="o">?</span>
        <span class="nv">options.id = </span><span class="nx">_</span><span class="p">.</span><span class="nx">uniqueId</span><span class="p">()</span>
      <span class="nx">@menuBars</span><span class="p">[</span><span class="nx">options</span><span class="p">.</span><span class="nx">id</span><span class="p">]</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">_lib</span><span class="p">(</span><span class="nx">options</span><span class="p">)</span>
      <span class="nx">_t</span><span class="p">.</span><span class="nx">html</span> <span class="nx">@menuBars</span><span class="p">[</span><span class="nx">options</span><span class="p">.</span><span class="nx">id</span><span class="p">].</span><span class="nx">render</span><span class="p">().</span><span class="nx">el</span>
      <span class="k">return</span> <span class="nx">@menuBars</span><span class="p">[</span><span class="nx">options</span><span class="p">.</span><span class="nx">id</span><span class="p">]</span>

  <span class="nx">loadContext</span><span class="o">:</span><span class="nf">(name) -&gt;</span>
    <span class="nv">_context = </span><span class="nx">require</span> <span class="s">&#39;models/core/context&#39;</span>
    <span class="k">if</span> <span class="o">!</span><span class="nx">@context</span><span class="p">[</span><span class="nx">name</span><span class="p">]</span><span class="o">?</span>
      <span class="nx">@context</span><span class="p">[</span><span class="nx">name</span><span class="p">]</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">_context</span><span class="p">({</span><span class="nx">name</span><span class="o">:</span><span class="nx">name</span><span class="p">})</span>
      <span class="nv">a = </span><span class="nx">@context</span><span class="p">[</span><span class="nx">name</span><span class="p">].</span><span class="nx">fetch</span><span class="p">()</span>
    <span class="k">return</span> <span class="nx">@context</span><span class="p">[</span><span class="nx">name</span><span class="p">]</span>

  <span class="nx">alert</span><span class="o">:</span><span class="nf">(message, alert_type, pop=false) -&gt;</span>    
    <span class="k">if</span> <span class="nx">@inAnim</span> <span class="o">is</span> <span class="kc">true</span>
      <span class="nx">@alertStack</span><span class="p">.</span><span class="nx">push</span> <span class="p">{</span><span class="nv">message: </span><span class="nx">message</span><span class="p">,</span> <span class="nv">alert_type: </span><span class="nx">alert_type</span><span class="p">}</span>
      <span class="k">return</span>

    <span class="k">switch</span> <span class="nx">alert_type</span>
      <span class="k">when</span> <span class="s">&quot;clear&quot;</span>
        <span class="vi">@inAnim = </span><span class="kc">true</span>
        <span class="nx">$</span><span class="p">(</span><span class="s">&quot;</span><span class="err">#</span><span class="s">messages &gt; .alert&quot;</span><span class="p">).</span><span class="nx">fadeOut</span><span class="p">(</span><span class="mi">400</span><span class="p">,</span> <span class="p">(</span><span class="o">=&gt;</span>
          <span class="vi">@inAnim = </span><span class="kc">false</span>
          <span class="nx">$</span><span class="p">(</span><span class="s">&quot;</span><span class="err">#</span><span class="s">messages &gt; .alert:hidden&quot;</span><span class="p">).</span><span class="nx">remove</span><span class="p">()</span>
          <span class="nv">stack = </span><span class="nx">_</span><span class="p">.</span><span class="nx">clone</span><span class="p">(</span><span class="nx">@alertStack</span><span class="p">)</span>
          <span class="vi">@alertStack = </span><span class="p">[]</span>
          <span class="k">for</span> <span class="nx">alert</span> <span class="k">in</span> <span class="nx">stack</span>
            <span class="nx">@alert</span><span class="p">(</span><span class="nx">alert</span><span class="p">.</span><span class="nx">message</span><span class="p">,</span> <span class="nx">alert</span><span class="p">.</span><span class="nx">alert_type</span><span class="p">)</span>
        <span class="p">))</span>
      <span class="k">when</span> <span class="s">&quot;redirect&quot;</span>
        <span class="k">if</span> <span class="nx">message</span> <span class="o">is</span> <span class="s">&quot;@rebuild&quot;</span>
          <span class="nb">window</span><span class="p">.</span><span class="nx">location</span><span class="p">.</span><span class="nx">reload</span><span class="p">()</span>
        <span class="k">else</span> 
          <span class="nb">window</span><span class="p">.</span><span class="nx">SimpleSeer</span><span class="p">.</span><span class="nx">router</span><span class="p">.</span><span class="nx">navigate</span><span class="p">(</span><span class="nx">message</span> <span class="o">||</span> <span class="nb">window</span><span class="p">.</span><span class="nx">location</span><span class="p">.</span><span class="nx">hash</span><span class="p">,</span> <span class="kc">true</span><span class="p">)</span>
      <span class="k">else</span> 
        <span class="k">if</span> <span class="o">!</span><span class="nx">message</span> <span class="k">then</span> <span class="k">return</span> <span class="kc">false</span>
        <span class="nv">_duplicate = </span><span class="kc">false</span></pre></div>             </td>           </tr>                               <tr id="section-8">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-8">&#182;</a>               </div>               <p>console.group(new Date()); console.log(message); console.groupEnd();
$(".alert-#{alert_type}").each (e,v)->
 if ($(v).data("message") == message) then _duplicate = true</p>             </td>             <td class="code">               <div class="highlight"><pre>        
        <span class="k">if</span> <span class="nx">_duplicate</span> <span class="o">is</span> <span class="kc">false</span>
          <span class="nv">popup = </span><span class="nx">$</span><span class="p">(</span><span class="s">&quot;&lt;div style=\&quot;display: none\&quot;&gt;</span><span class="si">#{</span><span class="nx">message</span><span class="si">}</span><span class="s">&lt;/div&gt;&quot;</span><span class="p">)</span>
          <span class="nx">popup</span><span class="p">.</span><span class="nx">addClass</span><span class="p">(</span><span class="s">&quot;alert alert-</span><span class="si">#{</span><span class="nx">alert_type</span><span class="si">}</span><span class="s">&quot;</span><span class="p">).</span><span class="nx">data</span><span class="p">(</span><span class="s">&quot;message&quot;</span><span class="p">,</span> <span class="nx">message</span><span class="p">).</span><span class="nx">appendTo</span><span class="p">(</span><span class="s">&quot;</span><span class="err">#</span><span class="s">messages&quot;</span><span class="p">)</span>
          <span class="nv">closeBtn = </span><span class="nx">$</span><span class="p">(</span><span class="s">&quot;&lt;div class=&#39;closeAlerts&#39;&gt;&lt;/div&gt;&quot;</span><span class="p">)</span>
          <span class="nx">closeBtn</span><span class="p">.</span><span class="nx">click</span><span class="p">(</span><span class="nf">(e, ui) =&gt;</span> <span class="nx">$</span><span class="p">(</span><span class="nx">e</span><span class="p">.</span><span class="nx">currentTarget</span><span class="p">).</span><span class="nx">parent</span><span class="p">().</span><span class="nx">fadeOut</span><span class="p">(</span><span class="nf">-&gt;</span> <span class="nx">$</span><span class="p">(</span><span class="k">this</span><span class="p">).</span><span class="nx">remove</span><span class="p">())).</span><span class="nx">appendTo</span><span class="p">(</span><span class="nx">popup</span><span class="p">)</span>
          <span class="nx">popup</span><span class="p">.</span><span class="nx">fadeIn</span><span class="p">()</span></pre></div>             </td>           </tr>                               <tr id="section-9">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-9">&#182;</a>               </div>               <p>Uses a regular expression to determine
if the user is on a mobile browser or not.</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nv">isMobile:</span>
    <span class="sr">/android.+mobile|avantgo|bada\/|blackberry|blazer|compal|elaine|fennec|hiptop|iemobile|ip(hone|od)|iris|kindle|lge |maemo|midp|mmp|netfront|opera m(ob|in)i|palm( os)?|phone|p(ixi|re)\/|plucker|pocket|psp|symbian|treo|up\.(browser|link)|vodafone|wap|windows (ce|phone)|xda|xiino/i</span><span class="p">.</span><span class="nx">test</span><span class="p">(</span><span class="nx">navigator</span><span class="p">.</span><span class="nx">userAgent</span> <span class="o">||</span> <span class="nx">navigator</span><span class="p">.</span><span class="nx">vendor</span> <span class="o">||</span> <span class="nb">window</span><span class="p">.</span><span class="nx">opera</span><span class="p">)</span> <span class="o">or</span> <span class="sr">/1207|6310|6590|3gso|4thp|50[1-6]i|770s|802s|a wa|abac|ac(er|oo|s\-)|ai(ko|rn)|al(av|ca|co)|amoi|an(ex|ny|yw)|aptu|ar(ch|go)|as(te|us)|attw|au(di|\-m|r |s )|avan|be(ck|ll|nq)|bi(lb|rd)|bl(ac|az)|br(e|v)w|bumb|bw\-(n|u)|c55\/|capi|ccwa|cdm\-|cell|chtm|cldc|cmd\-|co(mp|nd)|craw|da(it|ll|ng)|dbte|dc\-s|devi|dica|dmob|do(c|p)o|ds(12|\-d)|el(49|ai)|em(l2|ul)|er(ic|k0)|esl8|ez([4-7]0|os|wa|ze)|fetc|fly(\-|_)|g1 u|g560|gene|gf\-5|g\-mo|go(\.w|od)|gr(ad|un)|haie|hcit|hd\-(m|p|t)|hei\-|hi(pt|ta)|hp( i|ip)|hs\-c|ht(c(\-| |_|a|g|p|s|t)|tp)|hu(aw|tc)|i\-(20|go|ma)|i230|iac( |\-|\/)|ibro|idea|ig01|ikom|im1k|inno|ipaq|iris|ja(t|v)a|jbro|jemu|jigs|kddi|keji|kgt( |\/)|klon|kpt |kwc\-|kyo(c|k)|le(no|xi)|lg( g|\/(k|l|u)|50|54|\-[a-w])|libw|lynx|m1\-w|m3ga|m50\/|ma(te|ui|xo)|mc(01|21|ca)|m\-cr|me(di|rc|ri)|mi(o8|oa|ts)|mmef|mo(01|02|bi|de|do|t(\-| |o|v)|zz)|mt(50|p1|v )|mwbp|mywa|n10[0-2]|n20[2-3]|n30(0|2)|n50(0|2|5)|n7(0(0|1)|10)|ne((c|m)\-|on|tf|wf|wg|wt)|nok(6|i)|nzph|o2im|op(ti|wv)|oran|owg1|p800|pan(a|d|t)|pdxg|pg(13|\-([1-8]|c))|phil|pire|pl(ay|uc)|pn\-2|po(ck|rt|se)|prox|psio|pt\-g|qa\-a|qc(07|12|21|32|60|\-[2-7]|i\-)|qtek|r380|r600|raks|rim9|ro(ve|zo)|s55\/|sa(ge|ma|mm|ms|ny|va)|sc(01|h\-|oo|p\-)|sdk\/|se(c(\-|0|1)|47|mc|nd|ri)|sgh\-|shar|sie(\-|m)|sk\-0|sl(45|id)|sm(al|ar|b3|it|t5)|so(ft|ny)|sp(01|h\-|v\-|v )|sy(01|mb)|t2(18|50)|t6(00|10|18)|ta(gt|lk)|tcl\-|tdg\-|tel(i|m)|tim\-|t\-mo|to(pl|sh)|ts(70|m\-|m3|m5)|tx\-9|up(\.b|g1|si)|utst|v400|v750|veri|vi(rg|te)|vk(40|5[0-3]|\-v)|vm40|voda|vulc|vx(52|53|60|61|70|80|81|83|85|98)|w3c(\-| )|webc|whit|wi(g |nc|nw)|wmlb|wonu|x700|yas\-|your|zeto|zte\-/i</span><span class="p">.</span><span class="nx">test</span><span class="p">((</span><span class="nx">navigator</span><span class="p">.</span><span class="nx">userAgent</span> <span class="o">||</span> <span class="nx">navigator</span><span class="p">.</span><span class="nx">vendor</span> <span class="o">||</span> <span class="nb">window</span><span class="p">.</span><span class="nx">opera</span><span class="p">).</span><span class="nx">substr</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">4</span><span class="p">))</span>

</pre></div>             </td>           </tr>                </tbody>     </table>   </div> </body> </html> 